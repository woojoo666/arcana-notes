<html>
<head>
	<script src="node_modules/nearley/lib/nearley.js"></script>
	<script src="grammar.js"></script>
	<script src="parser.js"></script>
</head>
<body>
<script>
// Grammar:

// Object 	::= ( Templt Block ) | Templt INDENT Block DEDENT							creation
// Object 	::= Object( Templt Block ) | Object Templt INDENT Block DEDENT				cloning
// Templt 	::= template | ε															templates
// Block 	::= Statemnt, Block | Statemnt | ε											note that we allow trailing commas at the end of a block
// Statemnt ::= Key: Object																properties
// Block 	::= Object, Block | Object Block											list items (can't use Statemnt nonterminal here, because of the special spaces separator)
// Object 	::= Object.Name | Object.#Tag | Object[Object]								property access (property names can start with #)
// Object 	::= Name | _Name															objects can refer to public or private vars (tho perhaps I should use separate rule for private vars, like Tag or Key)
// Object 	::= Object Op Object														operators (TODO: operator precedence)
// Statemnt ::= Object <: Object														insertion
// Statemnt ::= tag #Tag: Object														tag declaration (note that tag names cannot start with #)
// Statemnt ::= Object.#Tag: Object														tag usage
// Tag 		::= Name
// Statemnt ::= if (Object) Object else Object											conditionals
// Statemnt ::= for Key in Object: Block												for-loop
// Key 		::= Name
// Name     ::= [A-z0-9][A-z0-9_]*														names cannot start with "_", but they can have them inside

</script>
<script>

// some empty lines with spaces and tabs in them
var emptyLinesTest = `
	    
	test


	lineWithComment   // some comment
 
`;

var test1 = `
a: 10
b: 20
c: (x: a, y: b)
d:
	foo: 1
	bar: 2
`;

var testIndentation = `start
in this 	program
	I 	test indentation
parsing
	these are
	some statements
	on the same level
here
	we
	test
		multiple
			dedentations
at once`;

var testIndentation2 = `start
test
	indentedLastLine`;

var badIndentation = `start
this
		is
	bad
indentation`;

var alreadyCommas = `start
make
	sure we,
	aren't adding,
	double commas,`;

var indentedFirstLine = `		start
		first line
		indentation level 2
			test
				test`;

var dedentPastFirstLine = `		start
		first line
		indentation level 2
oops`;

// preprocessing
function preprocessor(program) {
	var processed = program;
	processed = emptyLinesAndCommentsProcessing(processed);
	processed = indentationProcessing(processed);

	return processed;
}

function emptyLinesAndCommentsProcessing(text) {
	text = text.replace(/(^|\n)\s*\n/g, (_, linebreak) => linebreak); // removes empty lines at start or middle of program
	text = text.replace(/\s*$/g, '');        // removes empty lines and whitespace at end of program

	text = text.replace(/\/\/.*($|\n)/g, (_, linebreak) => linebreak);    // strips out comments

	return text;
}

// note that text input should not have empty lines
//
// parse each line, such that:
//    * when indentation increases, use an {INDENT} token
//    * when indentation decreases, use a {DEDENT} token
//       * note that indentation can decrease multiple times at once
//    * if indentation stays the same, insert a "," delimiter if there isn't one already
//
// also note that the initial indentation level of the program is determined by the first line
function indentationProcessing(text) {

	let firstLineIndentation = text.match(/^\t*/)[0].length; // subtract out first ^ char

	let indentationStack = [firstLineIndentation];
	let lastLevel = indentationStack[indentationStack.length - 1];  // lastLevel is always the top of the stack

	// add a newline at the end with same indentation as first line, to finalize the indentation processing
	text += '\n' + '\t'.repeat(firstLineIndentation);

	const INDENT_TOKEN = '{INDENT}';
	const DEDENT_TOKEN = '{DEDENT}';

	// find every newline via regex, and process the indentation after it
	return text.replace(/(,?)\n(\t*)/g, (_, comma, indentation) => {
		let indentationLevel = indentation.length;   // counts number of indents
		let replacement = '';

		if (indentationLevel > lastLevel) {
			// if indentation increased, push new level to stack, and insert "INDENT" token to program
			indentationStack.push(indentationLevel);
			lastLevel = indentationStack[indentationStack.length - 1];
			replacement = INDENT_TOKEN;

		} else if (indentationLevel == lastLevel) {
			// for statements that are on the same level, replace the newline with a comma if there isn't one already
			replacement = comma || ',';

		} else {
			// if indentation decreased, pop levels from stack and insert "DEDENT" token to program, until indentation level matches
			while (indentationLevel < lastLevel) {
				indentationStack.pop();
				lastLevel = indentationStack[indentationStack.length - 1];
				replacement += DEDENT_TOKEN;
			}
			if (indentationLevel != lastLevel) {
				// INVALID INDENTATION, we have dedented to a level that we never indented to in the first place (see "badIndentation" test)
				// note that this will also naturally catch cases where we dedent past the first line indentation (see "dedentPastFirstLine" test)
				throw Error("Pre-processing error, bad indentation");
			}
		}
		return replacement;
	});
}

console.log(emptyLinesAndCommentsProcessing(emptyLinesTest));
console.log(emptyLinesAndCommentsProcessing(test1));


// note that these tests will add an extra comma at the front
console.log(indentationProcessing(testIndentation));
console.log(indentationProcessing(testIndentation2));

try {
console.log(indentationProcessing(badIndentation));
} catch (err) {
	console.log(err);
}

console.log(indentationProcessing(alreadyCommas));

console.log(indentationProcessing(indentedFirstLine));

try {
console.log(indentationProcessing(dedentPastFirstLine));
} catch (err) {
	console.log(err);
}

</script>
<script>
// parse function from parser.js

var parsetests = [
	'testkey:testval,nested:(nestkey:nestval),empty:(),notrailing:comma',
	'trailing:comma,',
	'this:should:fail',
];

parsetests.forEach(test => {
	console.log("Test Parse: " + test);
	console.log(parse(test));
});
</script>
</body>
</html>
