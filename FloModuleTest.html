<html>

<body>
	<pre id="log"></pre>

	<script src="FloModule.js"></script>

	<!-- overload console.log to output it to the page as well -->
	<script>
	console.log = (function (old_function, div_log) { 
		return function (text) {
			old_function(text);
			div_log.textContent += text + '\n';
		};
	} (console.log.bind(console), document.getElementById("log")));
	</script>

	<!-- tests -->
	<script>
	var test = new FloModule();

	// basic tests
	test.set('a', 5);
	test.set('b', 10);
	test.bind('c', ['a', 'b'], (a,b) => a+b);
	console.log(test.get('c'));
	test.set('b', 12);
	console.log(test.get('c'));

	// collection binding
	test.set('ar', [1,2,3]);

	// filter bind
	test.bind('devnull', ['ar'], function (ar) {
		// leverage reduce bind to append all results to an array
		var triggers = ar.map((x,i) => 'ar.' + i);
		test.bind('evens', triggers, () => ar.reduce((acc, val) => val%2 === 0 ? acc.concat(val) : acc, []));
	});

	// map bind
	test.bind('devnull', ['evens'], function (ar) {
		test.set('evens2',[]);
		ar.forEach((_, i) => test.bind('evens2.'+i, ['evens.'+i], val => val*val));
	});

	// reduce bind
	test.bind('devnull', ['evens2'], function (ar) {
		var triggers = ar.map((x,i) => 'evens2.' + i);
		test.bind('evens2sum', triggers, () => ar.reduce((acc, val) => acc+val, 0));
	});

	function checker () {
		return test.get('ar').filter(x => x%2 === 0).map(x => x*x).reduce((acc,x) => acc+x, 0);
	}

	console.log(test.get('evens2sum') + ' should be ' + checker());
	test.set('ar.1', 5);
	console.log(test.get('evens2sum') + ' should be ' + checker());
	test.set('ar.3', 4);
	console.log(test.get('evens2sum') + ' should be ' + checker());
	test.set('ar', [5,6]);
	console.log(test.get('evens2sum') + ' should be ' + checker());
	</script>
</body>

</html>
